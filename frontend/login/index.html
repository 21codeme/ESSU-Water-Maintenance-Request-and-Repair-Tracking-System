<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - ESSU Water Maintenance</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíß</text></svg>">
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="logo">
                    <span class="logo-icon">üíß</span>
                    <h1>ESSU Water Maintenance</h1>
                </div>
                <h2>Staff Login</h2>
                <p>Access the maintenance dashboard</p>
            </div>

            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" required 
                           placeholder="your.email@essu.edu" autocomplete="email">
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="password-input">
                        <input type="password" id="password" name="password" required 
                               placeholder="Enter your password" autocomplete="current-password">
                        <button type="button" class="password-toggle" onclick="togglePassword()">
                            <span class="eye-icon">üëÅÔ∏è</span>
                        </button>
                    </div>
                </div>

                <div class="form-options">
                    <label class="checkbox-label">
                        <input type="checkbox" id="rememberMe" name="rememberMe">
                        <span class="checkmark"></span>
                        Remember me
                    </label>
                </div>

                <button type="submit" class="btn btn-primary btn-large login-btn">
                    <span class="btn-text">Login</span>
                    <span class="btn-loading" style="display: none;">Signing in...</span>
                </button>
            </form>

            <div id="message" class="message" style="display: none;"></div>

            <div class="login-footer">
                <div class="demo-credentials">
                    <h4>Demo Credentials</h4>
                    <div class="credential-item">
                        <strong>Admin:</strong> admin@essu.edu / admin123
                    </div>
                    <div class="credential-item">
                        <strong>Technician:</strong> tech@essu.edu / tech123
                    </div>
                </div>
                
                <div class="help-links">
                    <a href="mailto:support@essu.edu">Need help?</a>
                    <a href="../index.html">Back to Home</a>
                </div>
            </div>
        </div>

        <div class="login-info">
            <h3>Welcome Back!</h3>
            <p>Access your maintenance dashboard to:</p>
            <ul class="feature-list">
                <li>üìã View and manage maintenance reports</li>
                <li>üë∑ Assign reports to technicians</li>
                <li>üìä Track progress and statistics</li>
                <li>üìß Send updates to reporters</li>
                <li>‚öôÔ∏è Manage user accounts</li>
            </ul>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        const loginForm = document.getElementById('loginForm');
        const messageDiv = document.getElementById('message');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = loginForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');
            
            // Show loading state
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
            
            try {
                const formData = new FormData(loginForm);
                const email = formData.get('email');
                const password = formData.get('password');
                
                let result;
                
                // Try API login - always use real API if server is available
                try {
                    result = await API.auth.login(email, password);
                    console.log('‚úÖ Login successful via API');
                } catch (apiError) {
                    console.error('‚ùå API login error:', apiError);
                    
                    // Check if it's a connection error or authentication error
                    if (apiError.message && (
                        apiError.message.includes('Failed to fetch') || 
                        apiError.message.includes('ERR_CONNECTION_REFUSED') ||
                        apiError.message.includes('NetworkError')
                    )) {
                        // Backend server is not available
                        showMessage('error', 'Backend server is not running. Please start the server first.');
                        throw new Error('Backend server is not available. Please start the server on port 3000.');
                    } else {
                        // Authentication error - invalid credentials
                        throw new Error(apiError.message || 'Invalid email or password');
                    }
                }
                
                // Store token and user info
                localStorage.setItem(CONFIG.TOKEN_KEY, result.token);
                localStorage.setItem(CONFIG.USER_KEY, JSON.stringify(result.user));
                
                showMessage('success', 'Login successful! Redirecting...');
                
                // Redirect based on user role
                setTimeout(() => {
                    if (result.user.role === 'admin') {
                        window.location.href = '../admin/index.html';
                    } else if (result.user.role === 'technician') {
                        window.location.href = '../dashboard/index.html';
                    } else {
                        window.location.href = '../myreports/index.html';
                    }
                }, 1000);
            } catch (error) {
                console.error('Login error:', error);
                showMessage('error', error.message || 'Invalid email or password');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
            }
        });

        function showMessage(type, text) {
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = text;
            messageDiv.style.display = 'block';
            
            // Auto-hide success messages
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        }

        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const eyeIcon = document.querySelector('.eye-icon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.textContent = 'üôà';
            } else {
                passwordInput.type = 'password';
                eyeIcon.textContent = 'üëÅÔ∏è';
            }
        }

        // Check if user is already logged in
        document.addEventListener('DOMContentLoaded', function() {
            // Warn if accessing via file:// protocol
            if (window.location.protocol === 'file:') {
                showMessage('warning', '‚ö†Ô∏è You are opening this file directly. For proper functionality, please access through a web server.');
            }
            // Note: Frontend can now work on any port - API URL is auto-detected

            const token = localStorage.getItem(CONFIG.TOKEN_KEY);
            const user = localStorage.getItem(CONFIG.USER_KEY);
            
            // Always clear demo tokens
            if (token && token.startsWith('demo-token-')) {
                localStorage.removeItem(CONFIG.TOKEN_KEY);
                localStorage.removeItem(CONFIG.USER_KEY);
                showMessage('info', 'Please login again with your credentials.');
                return;
            }
            
            // Verify token is a valid JWT format (has 3 parts separated by dots)
            if (token && (typeof token === 'string' && (!token.includes('.') || token.split('.').length !== 3))) {
                // Not a valid JWT token, clear it
                localStorage.removeItem(CONFIG.TOKEN_KEY);
                localStorage.removeItem(CONFIG.USER_KEY);
                showMessage('info', 'Please login again with your credentials.');
                return;
            }
            
            if (token && user) {
                try {
                    const userData = JSON.parse(user);
                    // Only auto-redirect if we have a valid JWT token
                    if (token && typeof token === 'string' && token.split('.').length === 3) {
                        showMessage('info', `Already logged in as ${userData.full_name}. Redirecting...`);
                        
                        setTimeout(() => {
                            if (userData.role === 'admin') {
                                window.location.href = '../admin/index.html';
                            } else if (userData.role === 'technician') {
                                window.location.href = '../dashboard/index.html';
                            } else {
                                window.location.href = '../myreports/index.html';
                            }
                        }, 1000);
                    }
                } catch (error) {
                    // Invalid user data, clear and force re-login
                    localStorage.removeItem(CONFIG.TOKEN_KEY);
                    localStorage.removeItem(CONFIG.USER_KEY);
                }
            }
        });

        // Auto-fill demo credentials
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const demo = urlParams.get('demo');
            
            if (demo === 'admin') {
                document.getElementById('email').value = 'admin@essu.edu';
                document.getElementById('password').value = 'admin123';
            } else if (demo === 'tech') {
                document.getElementById('email').value = 'tech@essu.edu';
                document.getElementById('password').value = 'tech123';
            }
        });
    </script>
</body>
</html>

